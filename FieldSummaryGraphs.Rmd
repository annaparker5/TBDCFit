---
title: "Field Summary Graphs"
output: html_notebook
---

This script makes the summary graphs suggested by Joel on 11/8/22 to Anna. 

Roadmap:

0. Load in data and packages
1. For each metric (consumption, num flowers, num pods, num seeds germinated)
  a. Create full datasets and subsets (excluding columns A-H) 
  b. Create collated metric for each
  c. Graph separately (DC vs TB) as violin plots with jittered points
2. Plot fitness (num seeds germinated) vs. herbivory separately (DC vs TB)

# 0. Load in packages and data

```{r}
library(tidyverse)
library(ggplot2)
#library(nlme)
library(lmerTest)
```

```{r}
farea <- read.csv("~/Desktop/GitHub/TBDCFit/Data/FieldLeafArea.csv", header = TRUE)
fgerm <- read.csv("~/Desktop/GitHub/TBDCFit/Data/GermCollated.csv", header = TRUE)
fkey <- read.csv("~/Desktop/GitHub/TBDCFit/Data/pidTrtKey.csv", header = TRUE)
fpods <- read.csv("~/Desktop/GitHub/TBDCFit/Data/ExitData.csv", header = TRUE)
fTBseed <- read.csv("~/Desktop/GitHub/TBDCFit/Data/TBSeedCorrect.csv", header = TRUE)
fDCseed <- read.csv("~/Desktop/GitHub/TBDCFit/Data/DCSeed.csv", header = TRUE)
fflowers <- read.csv("~/Desktop/GitHub/TBDCFit/Data/FieldNumFlowers.csv", header = TRUE)
```


```{r}
fcolumn <- fkey %>%
  select(pid, column)
```


# 1. Create metrics and graph 

## A. Consumption

### Create subset dataset

Make a subset of `r fkey` and then merge with desired dataset

```{r}
fkeysubset <- fkey[fkey$block != "I", ]

fcolumnsubset <- fkeysubset %>%
  select(pid, column)

fkeysubset <- fkeysubset %>%
  select(pid, type, treatment)
```


### Create metric

Fix wrong PID in farea

```{r}
farea[farea$PID == 110, 1] <- 300
```


Merge `r fkeysubset` with `r farea`

```{r}
fareasubset <- merge(farea, fkeysubset, by.x = c("PID", "type", "treatment"), by.y = c("pid", "type", "treatment"))
```


### Graph


```{r}
fieldann3 <- data.frame(label = c("C", "D"), 
                   type = c("DC", "TB"), 
                   treatment = NA)
```


```{r}
fieldconsumpplotfull <- ggplot(aes(x = treatment, y = tot.area, color = treatment, shape = type), 
                           data = farea) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = expression(paste("Total leaf area consumed ", (cm^{2})))
       ) + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type) +
  theme(legend.position = "none")

fieldconsumpplotfull
```


```{r}
fieldconsumpplotsubset <- ggplot(aes(x = treatment, y = tot.area, color = treatment, shape = type), 
                           data = fareasubset) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = expression(paste("Total leaf area consumed ", (cm^{2})))
      ) + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type) +
  geom_text(data = fieldann3, aes(x = "CON", y = 6000, label = label), size = 10) + 
  theme(legend.position = "none")

fieldconsumpplotsubset
```

### Save graphs

```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/Fig3field.png", fieldconsumpplotsubset, width = 8, height = 5)
```

### Run stats

```{r}
farea <- merge(farea, fcolumn, by.x = "PID", by.y = "pid")
```

```{r}
fareasubset <- merge(fareasubset, fcolumnsubset, by.x = "PID", by.y = "pid")
```


```{r}
fmodconsumpsubsetcol <- lmer(tot.area ~ treatment*type + (1|column), data = fareasubset, REML = FALSE)

anova(fmodconsumpsubsetcol)
```



## B. Number of flowers

### Create metric

```{r}
fflowerssubset <- merge(fflowers, fkeysubset, by = "pid")

fflowerssubset <- merge(fflowerssubset, fcolumnsubset, by = "pid")

```

### Graph

```{r}
fieldannS1AB <- data.frame(label = c("A", "B"), 
                   type = c("DC", "TB"), 
                   treatment = NA, 
                   height = c(120, 245))
```



```{r}
fieldflowerplotsubset <- ggplot(aes(x = treatment, y = tot.flowers, color = treatment, shape = type), 
                           data = fflowerssubset) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = "Number of flowers produced" 
       ) + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type, scales = "free_y") +
  geom_text(data = fieldannS1AB, aes(x = "WOWE", y = height, label = label), size = 10) + 
  theme(legend.position = "none")

fieldflowerplotsubset
```


### Save graphs

```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/FigS2ABfield.png", fieldflowerplotsubset, width = 8, height = 5)
```

### Run stats

```{r}
fmodflowerssubsetcol <- lmer(tot.flowers ~ treatment*type + (1|column), data = fflowerssubset, REML = FALSE)

anova(fmodflowerssubsetcol)
```
**IS SINGULAR**


## C. Number of mature pods

### Create metric

```{r}
fpods <- fpods %>%
  select(PID, num.pod.m)

fpodssubset <- merge(fpods, fkeysubset, by.x = "PID", by.y = "pid")
fpodssubset <- merge(fpodssubset, fcolumnsubset, by.x = "PID", by.y = "pid")
```

### Graph


```{r}
fieldannS1CD <- data.frame(label = c("C", "D"), 
                   type = c("DC", "TB"), 
                   treatment = NA, 
                   height = c(45, 212.5))
```

```{r}
fieldpodsplotsubset <- ggplot(aes(x = treatment, y = num.pod.m, color = treatment, shape = type), 
                           data = fpodssubset) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = "Number of mature pods produced"
       ) + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type, scales = "free_y") +
  geom_text(data = fieldannS1CD, aes(x = "WOWE", y = height, label = label), size = 10) + 
  theme(legend.position = "none")

fieldpodsplotsubset
```

### Save graphs 

```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/FigS2CDfield.png", fieldpodsplotsubset, width = 8, height = 5)
```

### Run stats

```{r}
fmodpodssubsetcol <- lmer(num.pod.m ~ treatment*type + (1|column), data = fpodssubset, REML = FALSE)

anova(fmodpodssubsetcol)
```



## D. Seed set

### Create metric

Seed mass per TB pod 

```{r}
fTBseed$mass.per.pod <- fTBseed$Mass..g. / fTBseed$Total.Pods
```

Remove unnecessary columns fromm TBseed

```{r}
fTBseed <- fTBseed %>%
  select(pid = PID, per.pod = mass.per.pod)
```


Make for loop to count total number of DC seeds

```{r}
#1. List of unique PIDs in DCseed

fDCpid <- unique(fDCseed$pid)

#2. Make output dataset

fDCseedout <- data.frame(pid = fDCpid, 
                        pod.avg = 0)

#3. write the for loop 

for(i in 1:length(fDCpid)){
  subset <- fDCseed[fDCseed$pid == fDCpid[i], ]
  fDCseedout[i, 2] <- mean(subset$num.m.seeds)
}
```


```{r}
fDCseedout <- fDCseedout %>%
  select(pid, per.pod = pod.avg)
```


```{r}
fperpod <- rbind(fTBseed, fDCseedout)
```

Add in treatment groups

```{r}
fseedoutsubset <- merge(fperpod, fkeysubset, all.y = TRUE, by = c("pid"))
```

Add in germination success

```{r}
fgerm <- fgerm %>%
  select(pid, prop.sprouted)

fgermsubset <- merge(fgerm, fkeysubset, by = "pid")
```

Merge to main datafile

```{r}
fseedoutsubset <- merge(fseedoutsubset, fgermsubset, all.x = TRUE, by = c("pid", "type", "treatment"))
```


Remove individuals that were moldy or had spodoptera damage and we couldn't mass the pods, or that were too moldy to germinate

```{r}
fseedoutsubset <- fseedoutsubset[is.na(fseedoutsubset$prop.sprouted) == FALSE, ]
```

Add in number of pods

```{r}
fseedoutsubset <- merge(fseedoutsubset, fpodssubset, all.y = TRUE, by.x = c("pid", "type", "treatment"), by.y = c("PID", "type", "treatment"))
```

Keep plants with no mature pods, exclude plants with mature pods that we couldn't germinate. 

```{r}
fseedoutsubset <- fseedoutsubset[(!(fseedoutsubset$num.pod.m != 0 & is.na(fseedoutsubset$prop.sprouted) == TRUE)), ]
```


Get success

```{r}
fseedoutsubset$seed.tot <- fseedoutsubset$per.pod * fseedoutsubset$num.pod.m 

fseedoutsubset$success <- fseedoutsubset$seed.tot * fseedoutsubset$prop.sprouted

for(i in 1:length(fseedoutsubset$pid)){
  if(is.na(fseedoutsubset[i, 9]) == TRUE){
    fseedoutsubset[i, 8] <- 0
    fseedoutsubset[i, 9] <- 0
  } else if(is.na(fseedoutsubset[i, 9]) == FALSE){
    fseedoutsubset[i, 8] <- fseedoutsubset[i, 8]
    fseedoutsubset[i, 9] <- fseedoutsubset[i, 9]
  }
}
```


### Graph


```{r}
fieldannS1EF <- data.frame(label = c("E", "F"), 
                   type = c("DC", "TB"), 
                   treatment = NA, 
                   height = c(2300, 57))
```


```{r}
fieldseedplotsubset <- ggplot(aes(x = treatment, y = seed.tot, color = treatment, shape = type), 
                           data = fseedoutsubset) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = "Seed set") + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type, scales = "free_y") +
  geom_text(data = fieldannS1EF, aes(x = "WOWE", y = height, label = label), size = 10) + 
  theme(legend.position = "none")

fieldseedplotsubset
```
### Save graph

```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/FigS2EFfield.png", fieldseedplotsubset, width = 8, height = 5)
```


### Run stats

```{r}
fmodseedsubsetcol <- lmer(seed.tot ~ treatment*type + (1|column), data = fseedoutsubset, REML = FALSE)

anova(fmodseedsubsetcol)
```

## E. Germination success


```{r}
fieldannS1GH <- data.frame(label = c("G", "H"), 
                   type = c("DC", "TB"), 
                   treatment = NA, 
                   height = c(1.2, 1.2))
```


```{r}
fieldgermplotsubset <- ggplot(aes(x = treatment, y = prop.sprouted, color = treatment, shape = type), 
                           data = fseedoutsubset) + 
  theme_bw() + 
  geom_boxplot() + 
  #geom_point(alpha = 0.5, position = position_jitter(width = .2, height = 0)) + 
  labs(x = "Expected outcome", y = "Germination success") + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  #scale_shape_manual(values = c(1, 16)) + 
  facet_wrap(~ type, scales = "free_y") +
  geom_text(data = fieldannS1GH, aes(x = "WOWE", y = height, label = label), size = 10) + 
  theme(legend.position = "none")

fieldgermplotsubset
```

### Save graph

```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/FigS2GHfield.png", fieldgermplotsubset, width = 8, height = 5)
```


### Run stats

```{r}
fmodgermsubsetcol <- glmer(prop.sprouted ~ treatment*type + (1|column), family = "binomial", data = fseedoutsubset)

summary(fmodgermsubsetcol)

anova(fmodgermsubsetcol)

library(car)

Anova(fmodgermsubsetcol, type = 3)
```

**Model failed to converge**

# 2. Fitness plot

Get into one dataset

```{r}
ffitnesssubset <- merge(farea, fseedoutsubset, by.x = c("PID", "treatment", "type", "column"), by.y = c("pid", "treatment", "type", "column"))
```

**Fitness recalculations**

```{r}
ffitnesssubset$rel.fitness <- 0

ffitnesssubset[ffitnesssubset$type == "DC", 11] <- (ffitnesssubset[ffitnesssubset$type == "DC", 10]) / (mean(ffitnesssubset[ffitnesssubset$treatment == "CON" & ffitnesssubset$type == "DC", 10]))

ffitnesssubset[ffitnesssubset$type == "TB", 11] <- (ffitnesssubset[ffitnesssubset$type == "TB", 10]) / (mean(ffitnesssubset[ffitnesssubset$treatment == "CON" & ffitnesssubset$type == "TB", 10]))
```



```{r}
ffitnesssubset$rel.fitness.med <- 0

ffitnesssubset[ffitnesssubset$type == "DC", 12] <- (ffitnesssubset[ffitnesssubset$type == "DC", 10]) / (median(ffitnesssubset[ffitnesssubset$treatment == "CON" & ffitnesssubset$type == "DC", 10]))

ffitnesssubset[ffitnesssubset$type == "TB", 12] <- (ffitnesssubset[ffitnesssubset$type == "TB", 10]) / (median(ffitnesssubset[ffitnesssubset$treatment == "CON" & ffitnesssubset$type == "TB", 10]))
```


```{r}
fieldann4 <- data.frame(label = c("C", "D"), 
                   type = c("DC", "TB"), 
                   treatment = NA, 
                   height = c(1600, 32.5), 
                   width = c(2700, 5700))
```



```{r}
fieldfitnessplotsubset <- ggplot(aes(x = tot.area, y = rel.fitness), data = ffitnesssubset) + 
  theme_bw() +
  xlim(0, 7000) + 
  #ylim(0, 8) + 
  geom_smooth(aes(linetype = type), method = "lm", alpha = 0.2, color = "dark gray") +
  geom_point(aes(color = treatment, shape = type), alpha = 0.8, size = 2) + 
  labs(x = expression(paste("Total leaf area consumed ", (cm^{2}))), y = "Relative fitness", 
       color = "Expected outcome", shape = "Hostplant", linetype = "Hostplant") + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  scale_shape_manual(values = c(1, 16)) + 
  scale_linetype_manual(values = c("dashed", "solid")) + 
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14), 
        legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + 
  geom_text(aes(x = 6000, y = 7.5, label = "B"), size = 10, color = "gray40")
  #scale_y_continuous(limits=c(0,4.5), oob = scales::squish(x = , range = c(0, 4.5)))

fieldfitnessplotsubset
```

save graph: 
```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/Fig4fieldnew.png", fieldfitnessplotsubset, width = 8, height = 8)
```

```{r}
fieldfitnessplotsubsetmed <- ggplot(aes(x = tot.area, y = rel.fitness.med), data = ffitnesssubset) + 
  theme_bw() +
  xlim(0, 7000) + 
  ylim(0, 33) + 
  geom_smooth(aes(linetype = type), method = "lm", alpha = 0.2, color = "dark gray") +
  geom_point(aes(color = treatment, shape = type), alpha = 0.8) + 
  labs(x = expression(paste("Total leaf area consumed ", (cm^{2}))), y = "Relative fitness", 
       color = "Expected outcome", shape = "Hostplant", linetype = "Hostplant") + 
  scale_color_manual(values = c("black", "#1E88E5", "lime green", "#D81B60")) + 
  scale_shape_manual(values = c(1, 16)) + 
  scale_linetype_manual(values = c("dashed", "solid")) + 
  geom_text(aes(x = 6000, y = 31, label = "B"), size = 10, color = "gray40")
  #scale_y_continuous(limits=c(0,4.5), oob = scales::squish(x = , range = c(0, 4.5)))

fieldfitnessplotsubsetmed
```


save graph: 
```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/Fig4fieldmedian.png", fieldfitnessplotsubsetmed, width = 6, height = 5)
```

```{r}
GRCfitnessplotB <- ggplot(aes(x = tot.area, y = rel.fitness), data = ffitnesssubset) + 
  theme_bw() +
  xlim(0, 6500) + 
  #ylim(-1, 4) + 
  geom_smooth(aes(linetype = type), method = "lm", alpha = 0.2, color = "dark gray") +
  geom_point(aes(color = treatment, shape = type), alpha = 0.8, size = 2) + 
  labs(x = expression(paste("Total leaf area consumed ", (cm^{2}))), y = "Relative fitness", 
       color = "Expected outcome", shape = "Hostplant", linetype = "Hostplant") + 
  scale_color_manual(values = c("#1E88E5", "lime green", "#FFA502", "#D81B60")) + 
  scale_shape_manual(values = c(19, 5)) + 
  scale_linetype_manual(values = c("solid", "dotdash")) + 
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 16), 
        legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + 
  geom_text(aes(x = 2000, y = 3.5, label = "Field"), size = 12, color = "gray40") + 
  theme(legend.position = "none")

GRCfitnessplotB

```

save graph: 
```{r}
ggsave("~/Desktop/GitHub/TBDCFit/Figures/GRCFieldposterCI.png", GRCfitnessplotB, width = 8, height = 16)
```



### Stats

```{r}
fmodfitnesssubset <- lmer(rel.fitness ~ treatment*type + (1|column), data = ffitnesssubset, REML = FALSE)

anova(fmodfitnesssubset)
```

```{r}
fmodfitnesssubset1med <- lm(rel.fitness.med ~ treatment*type, data = ffitnesssubset)

anova(fmodfitnesssubset1med)
```



```{r}
fmodfitnesssubset2 <- lm(log(rel.fitness + 0.01) ~ tot.area*type, data = ffitnesssubset)

anova(fmodfitnesssubset2)
```



```{r}
fmodfitnesssubset3 <- lmer(rel.fitness ~ tot.area*type + (1|column), data = ffitnesssubset, REML = FALSE)

anova(fmodfitnesssubset3)
```

```{r}
fmodfitnesssubset4 <- lm(rel.fitness ~ tot.area*type, data = ffitnesssubset)

anova(fmodfitnesssubset4)
```

